"use strict";(self.webpackChunk_jupyter_shared_docprovider_extension=self.webpackChunk_jupyter_shared_docprovider_extension||[]).push([[672],{1672:(e,t,s)=>{s.r(t),s.d(t,{SharedDrive:()=>g,WebrtcProvider:()=>d});var r=s(5256),i=s(2200),n=s(7262),o=s(8482),a=s(4602),h=s(1473),l=s(2697),c=s(7354);class d{constructor(e){this._onPeers=e=>{0===e.webrtcPeers.length&&(0,i.showErrorMessage)(this._trans.__("All clients disconnected"),`If you close '${this._path}', all data will be lost (unless someone reconnects).`,[i.Dialog.okButton()])},this._onSync=e=>{e.synced&&this._ready.resolve()},this._ready=new n.PromiseDelegate,this._isDisposed=!1,this._path=e.path,this._contentType=e.contentType,this._format=e.format,this._sharedModel=e.model,this._awareness=e.model.awareness,this._yWebrtcProvider=null,this._trans=e.translator,this._signalingServers=e.signalingServers;const t=e.user;t.ready.then((()=>{this._onUserChanged(t)})).catch((e=>console.error(e))),t.userChanged.connect(this._onUserChanged,this),this._connect().catch((e=>console.warn(e)))}get isDisposed(){return this._isDisposed}get ready(){return this._ready.promise}dispose(){var e;this.isDisposed||(this._isDisposed=!0,null===(e=this._yWebrtcProvider)||void 0===e||e.destroy(),a.Signal.clearData(this))}async _connect(){this._yWebrtcProvider=new o.WebrtcProvider(`${this._format}:${this._contentType}:${this._path}}`,this._sharedModel.ydoc,{signaling:this._signalingServers,awareness:this._awareness}),this._yWebrtcProvider.on("synced",this._onSync),this._yWebrtcProvider.on("peers",this._onPeers)}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}}class p{constructor(e){this._parts=e.split("/"),""===this._parts[this._parts.length-1]&&this._parts.pop()}get parts(){return this._parts}get parent(){return this._parts.slice(0,this._parts.length-1).join("/")}get name(){return this._parts[this._parts.length-1]}}var _=s(2206);class y{constructor(){this._ydoc=new _.Doc,this._yroot=this._ydoc.getMap("root")}get ydoc(){return this._ydoc}_newDir(){return new _.Map}isDir(e){return!!this.get(e)}get(e){if(""===e)return this._yroot;let t=this._yroot;const s=new p(e).parts;let r="";const i=s.length-1;for(let e=0;e<s.length;e++){const n=s[e];if(!t.has(n))throw new Error(`No entry "${n}" in "${r}"`);if(t=t.get(n),t)r=""===r?n:`${r}/${n}`;else if(e<i)throw new Error(`Entry "${n}" in "${r}" is not a directory.`)}return t}newUntitled(e,t,s){t=null!=t?t:"",s=null!=s?s:"";let r=0,i="";const n=this.get(t).toJSON();for(;""===i;){const e=`shared${r}${s}`;e in n?r+=1:i=e}const o=new p(t).parts;o.push(i);const a=o.join("/");return e?this.createDirectory(a):this.createFile(a),a}createFile(e){this.get(new p(e).parent).set(new p(e).name,null)}createDirectory(e){this.get(new p(e).parent).set(new p(e).name,this._newDir())}delete(e){if(0===new p(e).parts.length)throw new Error("Cannot delete root directory");this.get(new p(e).parent).delete(new p(e).name)}move(e,t){if(0===new p(e).parts.length)throw new Error("Cannot move root directory");if(0===new p(t).parts.length)throw new Error("Cannot move to root directory");const s=this.get(new p(e).parent),r=this.get(new p(t).parent);let i=s.get(new p(e).name);null!==i&&(i=i.clone()),this.delete(e),r.set(new p(t).name,i)}}const u=JSON.parse(h.PageConfig.getOption("signalingServers"));class g{constructor(e,t,s,r,i){this._onSync=e=>{var t;e.synced&&(this._ready.resolve(),null===(t=this._fileSystemProvider)||void 0===t||t.off("synced",this._onSync))},this._onCreate=e=>{if("string"!=typeof e.format)return this.sharedModelFactory.documentFactories.get(e.contentType)(e);this._ydrive.get(e.path);const t=`${e.format}:${e.contentType}:${e.path}`,s=this._fileProviders.get(t);if(s)return s.sharedModel;const r=this.sharedModelFactory.documentFactories.get(e.contentType)(e),i=new d({url:"",path:e.path,format:e.format,contentType:e.contentType,model:r,user:this._user,translator:this._trans,signalingServers:this._signalingServers});return this._fileProviders.set(t,{provider:i,sharedModel:r}),r.disposed.connect((()=>{const e=this._fileProviders.get(t);e&&(e.provider.dispose(),this._fileProviders.delete(t))})),r},this._fileChanged=new a.Signal(this),this._isDisposed=!1,this._ydrive=new y,this._ready=new n.PromiseDelegate,this._signalingServers=[],this._importedFiles=new Map,this._user=e,this._defaultFileBrowser=t,this._trans=s,this._globalAwareness=r,this._fileProviders=new Map,this.sharedModelFactory=new m(this._onCreate),this.serverSettings=c.ServerConnection.makeSettings(),u.forEach((e=>{e.startsWith("ws://")||e.startsWith("wss://")||e.startsWith("http://")||e.startsWith("https://")?this._signalingServers.push(e):this._signalingServers.push(h.URLExt.join(this.serverSettings.wsUrl,e))})),this.name=i,this._fileSystemProvider=new o.WebrtcProvider("fileSystem",this._ydrive.ydoc,{signaling:this._signalingServers,awareness:this._globalAwareness||void 0}),this._fileSystemProvider.on("synced",this._onSync)}get providers(){const e=new Map;for(const t in this._fileProviders)e.set(t,this._fileProviders.get(t).provider);return e}async getDownloadUrl(e){return""}async delete(e){this._ydrive.delete(e)}async restoreCheckpoint(e,t){}async deleteCheckpoint(e,t){}async importFile(e,t){const s=await this._defaultFileBrowser.model.manager.services.contents.get(e,{content:!0});let r;r=t===`${this.name}:`?s.name:`${t.slice(this.name.length+1)}/${s.name}`,this._importedFiles.set(r,e),this._ydrive.createFile(r);const i=this.sharedModelFactory.createNew({path:r,format:s.format,contentType:s.type,collaborative:!0});i&&(i instanceof l.YNotebook?i.fromJSON(s.content):i.setSource(s.content))}async newUntitled(e={}){var t;let s="",r=!1;"directory"===e.type?r=!0:s="notebook"===e.type?".ipynb":".txt";const i=this._ydrive.newUntitled(r,e.path,s),n={name:new p(i).name,path:i,type:null!==(t=e.type)&&void 0!==t?t:"file",writable:!0,created:"",last_modified:"",mimetype:"",content:null,format:null};return this._fileChanged.emit({type:"new",oldValue:null,newValue:n}),n}async rename(e,t){return this._ydrive.move(e,t),{name:new p(t).name,path:t,type:"file",writable:!0,created:"",last_modified:"",mimetype:"",content:null,format:null}}async copy(e,t){throw new Error("Copy/paste not supported")}async createCheckpoint(e){return{id:"",last_modified:""}}async listCheckpoints(e){return[]}get fileChanged(){return this._fileChanged}get isDisposed(){return this._isDisposed}dispose(){this.isDisposed||(this._fileProviders.forEach((e=>e.provider.dispose())),this._fileProviders.clear(),this._isDisposed=!0,a.Signal.clearData(this))}async get(e,t){let s;if(await this._ready,!this._ydrive.isDir(e))return{name:new p(e).name,path:e,type:"file",writable:!0,created:"",last_modified:"",mimetype:"",content:null,format:null};const r=[],i=this._ydrive.get(e);for(const[t,s]of i){const i=null!==s?"directory":"file";r.push({name:t,path:`${e}/${t}`,type:i,writable:!0,created:"",last_modified:"",mimetype:"",content:null,format:null})}return s={name:new p(e).name,path:e,type:"directory",writable:!0,created:"",last_modified:"",mimetype:"",content:r,format:null},s}async save(e,t={}){var s;const r=i.Dialog.okButton({label:this._trans.__("Export"),accept:!0}),n=await(0,i.showDialog)({title:this._trans.__("Export Fileâ€¦"),body:new w(null!==(s=this._importedFiles.get(e))&&void 0!==s?s:e),buttons:[i.Dialog.cancelButton(),r]}).then((e=>{var t;if(e.button.accept)return null!==(t=e.value)&&void 0!==t?t:void 0}));if(n)try{await this._defaultFileBrowser.model.manager.services.contents.save(n,t)}catch(e){await(0,i.showErrorMessage)(this._trans.__("File Export Error for %1",n),e)}const o={type:t.type,format:t.format,content:!1};return this.get(e,o)}}class m{constructor(e){this._onCreate=e,this.documentFactories=new Map}registerDocumentFactory(e,t){if(this.documentFactories.has(e))throw new Error(`The content type ${e} already exists`);this.documentFactories.set(e,t)}createNew(e){if("string"==typeof e.format){if(this.documentFactories.has(e.contentType))return this._onCreate(e)}else console.warn(`Only defined format are supported; got ${e.format}.`)}}class w extends r.Widget{constructor(e){super({node:f(e)})}getValue(){return this.node.value}}function f(e){const t=document.createElement("input");return t.value=e,t}}}]);