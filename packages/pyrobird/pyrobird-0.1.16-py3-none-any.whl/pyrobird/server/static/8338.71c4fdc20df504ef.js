"use strict";(self.webpackChunkfirebird=self.webpackChunkfirebird||[]).push([[8338],{8338:(D,w,l)=>{l.r(w),l.d(w,{THStackPainter:()=>P});var T=l(467),m=l(5461),E=l(3282),H=l(3641),v=l(3829),C=l(6636),A=l(4080);class P extends H.JW{constructor(n,s,e){super(n,s,e),this.firstpainter=null,this.painters=[]}cleanup(){this.getPadPainter()?.cleanPrimitives(n=>n===this.firstpainter||this.painters.indexOf(n)>=0),delete this.firstpainter,delete this.painters,super.cleanup()}buildStack(n){if(!n.fHists)return!1;const s=n.fHists.arr.length;if(s<=0)return!1;const e=(0,m.create)(m.clTList);e.Add((0,m.clone)(n.fHists.arr[0]),n.fHists.opt[0]);for(let i=1;i<s;++i){const t=(0,m.clone)(n.fHists.arr[i]),a=n.fHists.opt[i],o=e.arr[i-1],f=t.fXaxis,h=o.fXaxis;let d=f.fNbins===h.fNbins&&f.fXmin===h.fXmin&&f.fXmax===h.fXmax;if(!d&&f.fNbins>0&&f.fNbins<h.fNbins&&f.fXmin===h.fXmin&&Math.abs((f.fXmax-f.fXmin)/f.fNbins-(h.fXmax-h.fXmin)/h.fNbins)<1e-4){const r=new Array(o.fNcells).fill(0);for(let c=1;c<=f.fNbins;++c)r[c]=t.fArray[c];t.fNcells=o.fNcells,Object.assign(f,h),t.fArray=r,d=!0}if(!d)return console.warn(`When drawing THStack, cannot sum-up histograms ${t.fName} and ${o.fName}`),e.Clear(),!1;for(let r=0;r<t.fArray.length;++r)t.fArray[r]+=o.fArray[r];e.Add(t,a)}return n.fStack=e,!0}getMinMax(n){const s=this.getObject(),e=this.getPadPainter().getRootPad(!0);let i=0,t=0;const a=(r,c)=>{const p={min:0,max:0};let M=!0,k=!0;if(r.fMinimum!==m.kNoZoom&&(p.min=r.fMinimum,M=!1),r.fMaximum!==m.kNoZoom&&(p.max=r.fMaximum,k=!1),!M&&!k)return p;let S=1,N=r.fXaxis.fNbins,b=1,O=1,X=!0;r.fXaxis.TestBit(H.rb.kAxisRange)&&(S=r.fXaxis.fFirst,N=r.fXaxis.fLast),0===r._typename.indexOf(m.clTH2)&&(O=r.fYaxis.fNbins,r.fYaxis.TestBit(H.rb.kAxisRange)&&(b=r.fYaxis.fFirst,O=r.fYaxis.fLast));for(let u=b;u<=O;++u)for(let x=S;x<=N;++x){const g=r.getBinContent(x,u),_=c?r.getBinError(r.getBin(x,u)):0;M&&(X||g-_<p.min)&&(p.min=g-_),k&&(X||g+_>p.max)&&(p.max=g+_),X=!1}return p};if(this.options.nostack)for(let r=0;r<s.fHists.arr.length;++r){const c=a(s.fHists.arr[r],n);0===r?(i=c.min,t=c.max):(i=Math.min(i,c.min),t=Math.max(t,c.max))}else i=a(s.fStack.arr[0],n).min,t=a(s.fStack.arr[s.fStack.arr.length-1],n).max;const o=()=>{if(e&&(e.fLogv??(1===this.options.ndim?e.fLogy:e.fLogz))){t<=0&&(t=1),i<=0&&(i=1e-4*t);const r=1/(1+.5*Math.log10(t/i)),c=1+.2*Math.log10(t/i);i*=r,t*=c}else i>0&&i<.05*t&&(i=0)};t*=1+m.gStyle.fHistTopMargin,o();let f=t,h=i,d=!1;return s.fMaximum!==m.kNoZoom&&(t=s.fMaximum,f=Math.max(t,f),d=!0),s.fMinimum!==m.kNoZoom&&(i=s.fMinimum,h=Math.min(i,h),d=!0),d?o():i=t=m.kNoZoom,{min:i,max:t,min0:h,max0:f,zoomed:d,hopt:`hmin:${h};hmax:${f};minimum:${i};maximum:${t}`}}getHistDrawOption(n,s){let e=s||n.fOption||this.options.hopt;return e.toUpperCase().indexOf(this.options.hopt)<0&&(e+=" "+this.options.hopt),this.options.draw_errors&&!e&&(e="E"),this.options.pads||(e+=" same nostat"+this.options.auto),e}drawNextHisto(n,s){var e=this;return(0,T.A)(function*(){const i=e.getObject(),t=e.options.nostack?i.fHists:i.fStack,a=t?.arr?.length||0;if(n>=a)return e;const o=e.options.horder?n:a-n-1,f=e.options.nostack?`hists_${o}`:`stack_${o}`,h=t.arr[o],d=e.getHistDrawOption(h,t.opt[o]);if(s){const r=s.getSubPadPainter(n+1);if(!r)return e;const c=r.selectCurrentPad(r.this_pad_name);return e.hdraw_func(r.getDom(),h,d).then(p=>(p&&(p.setSecondaryId(e,f),e.painters.push(p)),r.selectCurrentPad(c),e.drawNextHisto(n+1,s)))}return o>0&&!e.options.nostack&&(h.$baseh=t.arr[o-1]),e.options.auto&&(h.$num_histos=a),e.hdraw_func(e.getDom(),h,d).then(r=>(r.setSecondaryId(e,f),e.painters.push(r),e.drawNextHisto(n+1,s)))})()}decodeOptions(n){this.options||(this.options={}),Object.assign(this.options,{ndim:1,nostack:!1,same:!1,horder:!0,has_errors:!1,draw_errors:!1,hopt:"",auto:""});const s=this.getObject(),e=s.fHistogram||(s.fHists?s.fHists.arr[0]:null)||(s.fStack?s.fStack.arr[0]:null),i=o=>{if(o.fSumw2&&o.fSumw2.length>0)for(let f=0;f<o.fSumw2.length;++f)if(o.fSumw2[f]>0)return!0;return!1};if(e&&0===e._typename.indexOf(m.clTH2)&&(this.options.ndim=2),2===this.options.ndim&&!n&&(n="lego1"),s.fHists&&!this.options.nostack)for(let o=0;o<s.fHists.arr.length;++o)this.options.has_errors=this.options.has_errors||i(s.fHists.arr[o]);this.options.nhist=s.fHists?.arr?.length??1;const t=new E.nC(n);this.options.nostack=t.check("NOSTACK"),t.check("STACK")&&(this.options.nostack=!1),this.options.same=t.check("SAME"),t.check("NOCLEAR"),["PFC","PLC","PMC"].forEach(o=>{t.check(o)&&(this.options.auto+=" "+o)}),this.options.pads=t.check("PADS"),this.options.pads&&(this.options.nostack=!0),this.options.hopt=t.remain();const a=t.check("LEGO");this.options.errors=t.check("E"),!this.options.nostack&&this.options.has_errors&&!a&&!t.check("HIST")&&this.options.hopt.indexOf("E")<0&&(this.options.draw_errors=!0),this.options.horder=this.options.nostack||a}createHistogram(n){const s=n.fHists,e=s?s.arr.length:0;if(!e){const a=(0,m.createHistogram)(m.clTH1I,100);return(0,m.setHistogramTitle)(a,n.fTitle),a.fBits|=m.kNoStats,a}const i=s.arr[0],t=(0,m.createHistogram)(1===this.options.ndim?m.clTH1I:m.clTH2I,i.fXaxis.fNbins,i.fYaxis.fNbins);t.fName="axis_hist",t.fBits|=m.kNoStats,Object.assign(t.fXaxis,i.fXaxis),2===this.options.ndim&&Object.assign(t.fYaxis,i.fYaxis);for(let a=1;a<e;++a){const o=s.arr[a];t.fXaxis.fLabels||(t.fXaxis.fXmin=Math.min(t.fXaxis.fXmin,o.fXaxis.fXmin),t.fXaxis.fXmax=Math.max(t.fXaxis.fXmax,o.fXaxis.fXmax)),2===this.options.ndim&&!t.fYaxis.fLabels&&(t.fYaxis.fXmin=Math.min(t.fYaxis.fXmin,o.fYaxis.fXmin),t.fYaxis.fXmax=Math.max(t.fYaxis.fXmax,o.fYaxis.fXmax))}return t.fTitle=n.fTitle,t}updateObject(n){if(!this.matchObjectType(n))return!1;const s=this.getObject();if(s.fHists=n.fHists,s.fStack=n.fStack,s.fTitle=n.fTitle,s.fMinimum=n.fMinimum,s.fMaximum=n.fMaximum,this.options.nostack||(this.options.nostack=!this.buildStack(s)),this.firstpainter){let t=n.fHistogram;t||(t=s.fHistogram=this.createHistogram(s));const a=this.getMinMax(this.options.errors||this.options.draw_errors);this.firstpainter.options.minimum=a.min,this.firstpainter.options.maximum=a.max,this.firstpainter._checked_zooming=!1,1===this.options.ndim?(this.firstpainter.ymin=a.min0,this.firstpainter.ymax=a.max0):(this.firstpainter.zmin=a.min0,this.firstpainter.zmax=a.max0),this.firstpainter.updateObject(t)}const e=this.options.nostack?s.fHists:s.fStack,i=e?.arr?.length??0;if(i!==this.painters.length)this.did_update=1,this.getPadPainter()?.cleanPrimitives(t=>this.painters.indexOf(t)>=0),this.painters=[];else{this.did_update=2;for(let t=0;t<i;++t){const a=this.options.horder?t:i-t-1,o=e.arr[a];this.painters[t].updateObject(o,this.getHistDrawOption(o,e.opt[a]))}}return!0}redraw(n){if(1===this.did_update)return delete this.did_update,this.drawNextHisto(0,this.options.pads?this.getPadPainter():null);if(2===this.did_update){delete this.did_update;const s=e=>e>=this.painters.length?Promise.resolve(this):this.painters[e].redraw(n).then(()=>s(e+1));return s(0)}}fillContextMenuItems(n){n.addchk(this.options.draw_errors,"Draw errors",s=>{this.options.draw_errors=s;const e=this.getObject(),i=this.options.nostack?e.fHists:e.fStack,t=i?.arr?.length??0;for(let a=0;a<t;++a){const o=this.options.horder?a:t-a-1;this.painters[a].decodeOptions(this.getHistDrawOption(i.arr[o],i.opt[o]))}this.redrawPad()},"Change draw erros in the stack")}static draw(n,s,e){return(0,T.A)(function*(){if(!s.fHists||!s.fHists.arr)return null;const i=new P(n,s,e);let t=null,a=!1;return(0,A.ensureTCanvas)(i,!1).then(()=>{if(i.decodeOptions(e),i.hdraw_func=1===i.options.ndim?v.TH1Painter.draw:C.TH2Painter.draw,i.options.pads)return t=i.getPadPainter(),t.doingDraw()&&t.pad?.fPrimitives&&t.pad.fPrimitives.arr.length>1&&0===t.pad.fPrimitives.arr.indexOf(s)?(a=!0,void console.log("special case with THStack with is already rendered - do nothing")):(t.cleanPrimitives(d=>d!==i),t.divide(i.options.nhist));if(i.options.nostack||(i.options.nostack=!i.buildStack(s)),i.options.same)return;!s.fHistogram&&(s.fHistogram=i.createHistogram(s));const f=i.getMinMax(i.options.errors||i.options.draw_errors);return i.hdraw_func(n,s.fHistogram,i.options.hopt+";"+f.hopt).then(d=>{i.addToPadPrimitives(),i.firstpainter=d,d.setSecondaryId(i,"hist")})}).then(()=>a?i:i.drawNextHisto(0,t))})()}}}}]);