"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[8965],{89033:(t,e,o)=>{o.d(e,{Z:()=>l});var i=o(4942),r=o(36750),s=o(49331),n=o(84287),a=o(39450);function u(t,e){const o={};for(const i in t)e.includes(i)||(o[i]=t[i]);return o}class l extends r.Z{constructor(){super(...arguments),(0,i.Z)(this,"state",void 0)}initializeAggregationLayer(t){super.initializeState(this.context),this.setState({ignoreProps:u(this.constructor._propTypes,t.data.props),dimensions:t})}updateState(t){super.updateState(t);const{changeFlags:e}=t;if(e.extensionsChanged){const t=this.getShaders({});t&&t.defines&&(t.defines.NON_INSTANCED_MODEL=1),this.updateShaders(t)}this._updateAttributes()}updateAttributes(t){this.setState({changedAttributes:t})}getAttributes(){return this.getAttributeManager().getShaderAttributes()}getModuleSettings(){const{viewport:t,mousePosition:e,gl:o}=this.context;return Object.assign(Object.create(this.props),{viewport:t,mousePosition:e,pickingActive:0,devicePixelRatio:(0,a.w)(o)})}updateShaders(t){}isAggregationDirty(t,e){void 0===e&&(e={});const{props:o,oldProps:i,changeFlags:r}=t,{compareAll:n=!1,dimension:a}=e,{ignoreProps:u}=this.state,{props:l,accessors:d=[]}=a,{updateTriggersChanged:g}=r;if(r.dataChanged)return!0;if(g){if(g.all)return!0;for(const t of d)if(g[t])return!0}if(n)return!!r.extensionsChanged||(0,s.tg)({oldProps:i,newProps:o,ignoreProps:u,propTypes:this.constructor._propTypes});for(const t of l)if(o[t]!==i[t])return!0;return!1}isAttributeChanged(t){const{changedAttributes:e}=this.state;return t?e&&void 0!==e[t]:!function(t){let e=!0;for(const o in t){e=!1;break}return e}(e)}_getAttributeManager(){return new n.Z(this.context.gl,{id:this.props.id,stats:this.context.stats})}}(0,i.Z)(l,"layerName","AggregationLayer")},79543:(t,e,o)=>{o.d(e,{K:()=>i,P:()=>r});const i=[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]];function r(t,e,o){let i;if(void 0===e&&(e=!1),void 0===o&&(o=Float32Array),Number.isFinite(t[0]))i=new o(t);else{i=new o(4*t.length);let e=0;for(let o=0;o<t.length;o++){const r=t[o];i[e++]=r[0],i[e++]=r[1],i[e++]=r[2],i[e++]=Number.isFinite(r[3])?r[3]:255}}if(e)for(let t=0;t<i.length;t++)i[t]/=255;return i}},36750:(t,e,o)=>{o.d(e,{Z:()=>u});var i=o(4942),r=o(5259),s=o(11482),n=o(77552),a=o(33230);class u extends r.Z{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every((t=>t.isLoaded))}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(t){}setState(t){super.setState(t),this.setNeedsUpdate()}getPickingInfo(t){let{info:e}=t;const{object:o}=e;return o&&o.__source&&o.__source.parent&&o.__source.parent.id===this.id?(e.object=o.__source.object,e.index=o.__source.index,e):e}filterSubLayer(t){return!0}shouldRenderSubLayer(t,e){return e&&e.length}getSubLayerClass(t,e){const{_subLayerProps:o}=this.props;return o&&o[t]&&o[t].type||e}getSubLayerRow(t,e,o){return t.__source={parent:this,object:e,index:o},t}getSubLayerAccessor(t){if("function"==typeof t){const e={index:-1,data:this.props.data,target:[]};return(o,i)=>o&&o.__source?(e.index=o.__source.index,t(o.__source.object,e)):t(o,i)}return t}getSubLayerProps(t){var e;void 0===t&&(t={});const{opacity:o,pickable:i,visible:r,parameters:s,getPolygonOffset:n,highlightedObjectIndex:u,autoHighlight:l,highlightColor:d,coordinateSystem:g,coordinateOrigin:h,wrapLongitude:c,positionFormat:p,modelMatrix:m,extensions:x,fetch:f,operation:y,_subLayerProps:T}=this.props,v={id:"",updateTriggers:{},opacity:o,pickable:i,visible:r,parameters:s,getPolygonOffset:n,highlightedObjectIndex:u,autoHighlight:l,highlightColor:d,coordinateSystem:g,coordinateOrigin:h,wrapLongitude:c,positionFormat:p,modelMatrix:m,extensions:x,fetch:f,operation:y},_=T&&t.id&&T[t.id],w=_&&_.updateTriggers,S=t.id||"sublayer";if(_){const e=this.props[a.Wb],o=t.type?t.type._propTypes:{};for(const t in _){const i=o[t]||e[t];i&&"accessor"===i.type&&(_[t]=this.getSubLayerAccessor(_[t]))}}Object.assign(v,t,_),v.id="".concat(this.props.id,"-").concat(S),v.updateTriggers={all:null===(e=this.props.updateTriggers)||void 0===e?void 0:e.all,...t.updateTriggers,...w};for(const t of x){const e=t.getSubLayerProps.call(this,t);e&&Object.assign(v,e,{updateTriggers:Object.assign(v.updateTriggers,e.updateTriggers)})}return v}_updateAutoHighlight(t){for(const e of this.getSubLayers())e.updateAutoHighlight(t)}_getAttributeManager(){return null}_postUpdate(t,e){let o=this.internalState.subLayers;const i=!o||this.needsUpdate();if(i){const t=this.renderLayers();o=(0,n.x)(t,Boolean),this.internalState.subLayers=o}(0,s.Z)("compositeLayer.renderLayers",this,i,o);for(const t of o)t.parent=this}}(0,i.Z)(u,"layerName","CompositeLayer")},18965:(t,e,o)=>{o.r(e),o.d(e,{default:()=>R,getLayer:()=>O});var i=o(4942),r=o(39450);const s=new Float32Array(12);function n(t,e){void 0===e&&(e=2);let o=0;for(const i of t)for(let t=0;t<e;t++)s[o++]=i[t]||0;return s}var a=o(6948),u=o(44211),l=o(4912),d=o(63346),g=o(53478),h=o(41576),c=o(33321),p=o(84287),m=o(39769),x=o(53982),f=o(5259),y=o(37832);class T extends f.Z{getShaders(){return{vs:"#define SHADER_NAME heatp-map-layer-vertex-shader\n\nuniform sampler2D maxTexture;\nuniform float intensity;\nuniform vec2 colorDomain;\nuniform float threshold;\nuniform float aggregationMode;\n\nattribute vec3 positions;\nattribute vec2 texCoords;\n\nvarying vec2 vTexCoords;\nvarying float vIntensityMin;\nvarying float vIntensityMax;\n\nvoid main(void) {\n  gl_Position = project_position_to_clipspace(positions, vec3(0.0), vec3(0.0));\n  vTexCoords = texCoords;\n  vec4 maxTexture = texture2D(maxTexture, vec2(0.5));\n  float maxValue = aggregationMode < 0.5 ? maxTexture.r : maxTexture.g;\n  float minValue = maxValue * threshold;\n  if (colorDomain[1] > 0.) {\n    maxValue = colorDomain[1];\n    minValue = colorDomain[0];\n  }\n  vIntensityMax = intensity / maxValue;\n  vIntensityMin = intensity / minValue;\n}\n",fs:"#define SHADER_NAME triangle-layer-fragment-shader\n\nprecision highp float;\n\nuniform float opacity;\nuniform sampler2D texture;\nuniform sampler2D colorTexture;\nuniform float aggregationMode;\n\nvarying vec2 vTexCoords;\nvarying float vIntensityMin;\nvarying float vIntensityMax;\n\nvec4 getLinearColor(float value) {\n  float factor = clamp(value * vIntensityMax, 0., 1.);\n  vec4 color = texture2D(colorTexture, vec2(factor, 0.5));\n  color.a *= min(value * vIntensityMin, 1.0);\n  return color;\n}\n\nvoid main(void) {\n  vec4 weights = texture2D(texture, vTexCoords);\n  float weight = weights.r;\n\n  if (aggregationMode > 0.5) {\n    weight /= max(1.0, weights.a);\n  }\n  if (weight <= 0.) {\n     discard;\n  }\n\n  vec4 linearColor = getLinearColor(weight);\n  linearColor.a *= opacity;\n  gl_FragColor =linearColor;\n}\n",modules:[y.Z]}}initializeState(t){let{gl:e}=t;this.getAttributeManager().add({positions:{size:3,noAlloc:!0},texCoords:{size:2,noAlloc:!0}}),this.setState({model:this._getModel(e)})}_getModel(t){const{vertexCount:e}=this.props;return new m.Z(t,{...this.getShaders(),id:this.props.id,geometry:new x.Z({drawMode:6,vertexCount:e})})}draw(t){let{uniforms:e}=t;const{model:o}=this.state,{texture:i,maxTexture:r,colorTexture:s,intensity:n,threshold:a,aggregationMode:u,colorDomain:l}=this.props;o.setUniforms({...e,texture:i,maxTexture:r,colorTexture:s,intensity:n,threshold:a,aggregationMode:u,colorDomain:l}).draw()}}(0,i.Z)(T,"layerName","TriangleLayer");var v=o(89033),_=o(79543);const w={mipmaps:!1,parameters:{10240:9729,10241:9729,10242:33071,10243:33071},dataFormat:6408},S=[0,0],b={SUM:0,MEAN:1},C={getPosition:{type:"accessor",value:t=>t.position},getWeight:{type:"accessor",value:1},intensity:{type:"number",min:0,value:1},radiusPixels:{type:"number",min:1,max:100,value:50},colorRange:_.K,threshold:{type:"number",min:0,max:1,value:.05},colorDomain:{type:"array",value:null,optional:!0},aggregation:"SUM",weightsTextureSize:{type:"number",min:128,max:2048,value:2048},debounceTimeout:{type:"number",min:0,max:1e3,value:500}},L=[a.h.BLEND_EQUATION_MINMAX,a.h.TEXTURE_FLOAT],M=[a.h.COLOR_ATTACHMENT_RGBA32F,a.h.FLOAT_BLEND],P={data:{props:["radiusPixels"]}};class A extends v.Z{constructor(){super(...arguments),(0,i.Z)(this,"state",void 0)}initializeState(){const{gl:t}=this.context;if(!(0,u.ag)(t,L))return this.setState({supported:!1}),void h.Z.error("HeatmapLayer: ".concat(this.id," is not supported on this browser"))();super.initializeAggregationLayer(P),this.setState({supported:!0,colorDomain:S}),this._setupTextureParams(),this._setupAttributes(),this._setupResources()}shouldUpdateState(t){let{changeFlags:e}=t;return e.somethingChanged}updateState(t){this.state.supported&&(super.updateState(t),this._updateHeatmapState(t))}_updateHeatmapState(t){const{props:e,oldProps:o}=t,i=this._getChangeFlags(t);(i.dataChanged||i.viewportChanged)&&(i.boundsChanged=this._updateBounds(i.dataChanged),this._updateTextureRenderingBounds()),i.dataChanged||i.boundsChanged?(clearTimeout(this.state.updateTimer),this.setState({isWeightMapDirty:!0})):i.viewportZoomChanged&&this._debouncedUpdateWeightmap(),e.colorRange!==o.colorRange&&this._updateColorTexture(t),this.state.isWeightMapDirty&&this._updateWeightmap(),this.setState({zoom:t.context.viewport.zoom})}renderLayers(){if(!this.state.supported)return[];const{weightsTexture:t,triPositionBuffer:e,triTexCoordBuffer:o,maxWeightsTexture:i,colorTexture:r,colorDomain:s}=this.state,{updateTriggers:n,intensity:a,threshold:u,aggregation:l}=this.props;return new(this.getSubLayerClass("triangle",T))(this.getSubLayerProps({id:"triangle-layer",updateTriggers:n}),{coordinateSystem:c.Df.DEFAULT,data:{attributes:{positions:e,texCoords:o}},vertexCount:4,maxTexture:i,colorTexture:r,aggregationMode:b[l]||0,texture:t,intensity:a,threshold:u,colorDomain:s})}finalizeState(t){super.finalizeState(t);const{weightsTransform:e,weightsTexture:o,maxWeightTransform:i,maxWeightsTexture:r,triPositionBuffer:s,triTexCoordBuffer:n,colorTexture:a,updateTimer:u}=this.state;null==e||e.delete(),null==o||o.delete(),null==i||i.delete(),null==r||r.delete(),null==s||s.delete(),null==n||n.delete(),null==a||a.delete(),u&&clearTimeout(u)}_getAttributeManager(){return new p.Z(this.context.gl,{id:this.props.id,stats:this.context.stats})}_getChangeFlags(t){const e={},{dimensions:o}=this.state;e.dataChanged=this.isAttributeChanged()||this.isAggregationDirty(t,{compareAll:!0,dimension:o.data}),e.viewportChanged=t.changeFlags.viewportChanged;const{zoom:i}=this.state;return t.context.viewport&&t.context.viewport.zoom===i||(e.viewportZoomChanged=!0),e}_createTextures(){const{gl:t}=this.context,{textureSize:e,format:o,type:i}=this.state;this.setState({weightsTexture:new l.Z(t,{width:e,height:e,format:o,type:i,...w}),maxWeightsTexture:new l.Z(t,{format:o,type:i,...w})})}_setupAttributes(){this.getAttributeManager().add({positions:{size:3,type:5130,accessor:"getPosition"},weights:{size:1,accessor:"getWeight"}}),this.setState({positionAttributeName:"positions"})}_setupTextureParams(){const{gl:t}=this.context,{weightsTextureSize:e}=this.props,o=Math.min(e,(0,r.ZS)(t,3379)),i=(0,u.ag)(t,M),{format:s,type:n}=function(t){let{gl:e,floatTargetSupport:o}=t;return o?{format:(0,r.D0)(e)?34836:6408,type:5126}:{format:6408,type:5121}}({gl:t,floatTargetSupport:i}),a=i?1:1/255;this.setState({textureSize:o,format:s,type:n,weightsScale:a}),i||h.Z.warn("HeatmapLayer: ".concat(this.id," rendering to float texture not supported, fallingback to low precession format"))()}getShaders(t){return super.getShaders("max-weights-transform"===t?{vs:"attribute vec4 inTexture;\nvarying vec4 outTexture;\n\nvoid main()\n{\noutTexture = inTexture;\ngl_Position = vec4(0, 0, 0, 1.);\ngl_PointSize = 1.0;\n}\n",_fs:"varying vec4 outTexture;\nvoid main() {\n  gl_FragColor = outTexture;\n  gl_FragColor.g = outTexture.r / max(1.0, outTexture.a);\n}\n"}:{vs:"attribute vec3 positions;\nattribute vec3 positions64Low;\nattribute float weights;\nvarying vec4 weightsTexture;\nuniform float radiusPixels;\nuniform float textureWidth;\nuniform vec4 commonBounds;\nuniform float weightsScale;\nvoid main()\n{\n  weightsTexture = vec4(weights * weightsScale, 0., 0., 1.);\n\n  float radiusTexels  = project_pixel_size(radiusPixels) * textureWidth / (commonBounds.z - commonBounds.x);\n  gl_PointSize = radiusTexels * 2.;\n\n  vec3 commonPosition = project_position(positions, positions64Low);\n  gl_Position.xy = (commonPosition.xy - commonBounds.xy) / (commonBounds.zw - commonBounds.xy) ;\n  gl_Position.xy = (gl_Position.xy * 2.) - (1.);\n}\n",_fs:"varying vec4 weightsTexture;\nfloat gaussianKDE(float u){\n  return pow(2.71828, -u*u/0.05555)/(1.77245385*0.166666);\n}\nvoid main()\n{\n  float dist = length(gl_PointCoord - vec2(0.5, 0.5));\n  if (dist > 0.5) {\n    discard;\n  }\n  gl_FragColor = weightsTexture * gaussianKDE(2. * dist);\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n"})}_createWeightsTransform(t){var e;void 0===t&&(t={});const{gl:o}=this.context;let{weightsTransform:i}=this.state;const{weightsTexture:r}=this.state;null===(e=i)||void 0===e||e.delete(),i=new d.Z(o,{id:"".concat(this.id,"-weights-transform"),elementCount:1,_targetTexture:r,_targetTextureVarying:"weightsTexture",...t}),this.setState({weightsTransform:i})}_setupResources(){const{gl:t}=this.context;this._createTextures();const{textureSize:e,weightsTexture:o,maxWeightsTexture:i}=this.state,r=this.getShaders("weights-transform");this._createWeightsTransform(r);const s=this.getShaders("max-weights-transform"),n=new d.Z(t,{id:"".concat(this.id,"-max-weights-transform"),_sourceTextures:{inTexture:o},_targetTexture:i,_targetTextureVarying:"outTexture",...s,elementCount:e*e});this.setState({weightsTexture:o,maxWeightsTexture:i,maxWeightTransform:n,zoom:null,triPositionBuffer:new g.Z(t,{byteLength:48,accessor:{size:3}}),triTexCoordBuffer:new g.Z(t,{byteLength:48,accessor:{size:2}})})}updateShaders(t){this._createWeightsTransform(t)}_updateMaxWeightValue(){const{maxWeightTransform:t}=this.state;t.run({parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32776}})}_updateBounds(t){void 0===t&&(t=!1);const{viewport:e}=this.context,o=[e.unproject([0,0]),e.unproject([e.width,0]),e.unproject([e.width,e.height]),e.unproject([0,e.height])].map((t=>t.map(Math.fround))),i=function(t){const e=t.map((t=>t[0])),o=t.map((t=>t[1])),i=Math.min.apply(null,e),r=Math.max.apply(null,e);return[i,Math.min.apply(null,o),r,Math.max.apply(null,o)]}(o),r={visibleWorldBounds:i,viewportCorners:o};let s=!1;if(t||!this.state.worldBounds||(n=this.state.worldBounds,!((a=i)[0]>=n[0]&&a[2]<=n[2]&&a[1]>=n[1]&&a[3]<=n[3]))){const t=this._worldToCommonBounds(i),e=this._commonToWorldBounds(t);this.props.coordinateSystem===c.Df.LNGLAT&&(e[1]=Math.max(e[1],-85.051129),e[3]=Math.min(e[3],85.051129),e[0]=Math.max(e[0],-360),e[2]=Math.min(e[2],360));const o=this._worldToCommonBounds(e);r.worldBounds=e,r.normalizedCommonBounds=o,s=!0}var n,a;return this.setState(r),s}_updateTextureRenderingBounds(){const{triPositionBuffer:t,triTexCoordBuffer:e,normalizedCommonBounds:o,viewportCorners:i}=this.state,{viewport:r}=this.context;t.subData(n(i,3));const s=i.map((t=>function(t,e){const[o,i,r,s]=e;return[(t[0]-o)/(r-o),(t[1]-i)/(s-i)]}(r.projectPosition(t),o)));e.subData(n(s,2))}_updateColorTexture(t){const{colorRange:e}=t.props;let{colorTexture:o}=this.state;const i=(0,_.P)(e,!1,Uint8Array);o?o.setImageData({data:i,width:e.length}):o=new l.Z(this.context.gl,{data:i,width:e.length,height:1,...w}),this.setState({colorTexture:o})}_updateWeightmap(){const{radiusPixels:t,colorDomain:e,aggregation:o}=this.props,{weightsTransform:i,worldBounds:s,textureSize:n,weightsTexture:a,weightsScale:u}=this.state;this.state.isWeightMapDirty=!1;const l=this._worldToCommonBounds(s,{useLayerCoordinateSystem:!0});if(e&&"SUM"===o){const{viewport:t}=this.context,o=t.distanceScales.metersPerUnit[2]*(l[2]-l[0])/n;this.state.colorDomain=e.map((t=>t*o*u))}else this.state.colorDomain=e||S;const d={radiusPixels:t,commonBounds:l,textureWidth:n,weightsScale:u};i.update({elementCount:this.getNumInstances()}),(0,r.s8)(this.context.gl,{clearColor:[0,0,0,0]},(()=>{i.run({uniforms:d,parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32774},clearRenderTarget:!0,attributes:this.getAttributes(),moduleSettings:this.getModuleSettings()})})),this._updateMaxWeightValue(),a.setParameters({10240:9729,10241:9729})}_debouncedUpdateWeightmap(t){void 0===t&&(t=!1);let{updateTimer:e}=this.state;const{debounceTimeout:o}=this.props;t?(e=null,this._updateBounds(!0),this._updateTextureRenderingBounds(),this.setState({isWeightMapDirty:!0})):(this.setState({isWeightMapDirty:!1}),clearTimeout(e),e=setTimeout(this._debouncedUpdateWeightmap.bind(this,!0),o)),this.setState({updateTimer:e})}_worldToCommonBounds(t,e){void 0===e&&(e={});const{useLayerCoordinateSystem:o=!1}=e,[i,r,s,n]=t,{viewport:a}=this.context,{textureSize:u}=this.state,{coordinateSystem:l}=this.props,d=o&&(l===c.Df.LNGLAT_OFFSETS||l===c.Df.METER_OFFSETS),g=d?a.projectPosition(this.props.coordinateOrigin):[0,0],h=2*u/a.scale;let p,m;return o&&!d?(p=this.projectPosition([i,r,0]),m=this.projectPosition([s,n,0])):(p=a.projectPosition([i,r,0]),m=a.projectPosition([s,n,0])),function(t,e,o){const[i,r,s,n]=t,a=s-i,u=n-r;let l=a,d=u;a/u<e/o?l=e/o*u:d=o/e*a,l<e&&(l=e,d=o);const g=(s+i)/2,h=(n+r)/2;return[g-l/2,h-d/2,g+l/2,h+d/2]}([p[0]-g[0],p[1]-g[1],m[0]-g[0],m[1]-g[1]],h,h)}_commonToWorldBounds(t){const[e,o,i,r]=t,{viewport:s}=this.context,n=s.unprojectPosition([e,o]),a=s.unprojectPosition([i,r]);return n.slice(0,2).concat(a.slice(0,2))}}(0,i.Z)(A,"layerName","HeatmapLayer"),(0,i.Z)(A,"defaultProps",C),o(67294);var D=o(61988),B=o(45511),Z=o(58371),z=o(63241),W=o(89503),j=o(89691),F=o(51805),N=o(11965);function E(t){return(0,N.tZ)("div",{className:"deckgl-tooltip"},(0,N.tZ)(F.Z,{label:(0,D.t)("Centroid (Longitude and Latitude): "),value:`(${t.coordinate[0]}, ${t.coordinate[1]})`}))}const O=(t,e,o,i)=>{var r,s,n,a;const u=t,{intensity:l=1,radius_pixels:d=30,aggregation:g="SUM",js_data_mutator:h,linear_color_scheme:c}=u;let p=e.data.features;h&&(p=(0,z.Z)(u.js_data_mutator)(p));const m=null==(r=(0,B.Z)())||null==(s=r.get(c))?void 0:s.createLinearScale([0,6]),x=null==m||null==(n=m.range())||null==(a=n.map((t=>(0,W.hexToRGB)(t))))?void 0:a.reverse();return new A({id:`heatmp-layer-${u.slice_id}`,data:p,intensity:l,radiusPixels:d,colorRange:x,aggregation:g.toUpperCase(),getPosition:t=>t.position,getWeight:t=>t.weight?t.weight:1,...(0,Z.N)(u,i,E)})},R=(0,j.G)(O,(function(t){return t.map((t=>t.position))}))}}]);
//# sourceMappingURL=e1492e6da9777b403b6b.chunk.js.map