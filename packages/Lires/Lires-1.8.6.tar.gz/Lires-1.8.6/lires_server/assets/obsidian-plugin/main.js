/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var x=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var A=(r,i)=>{for(var e in i)x(r,e,{get:i[e],enumerable:!0})},M=(r,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of N(i))!R.call(r,s)&&s!==e&&x(r,s,{get:()=>i[s],enumerable:!(t=$(i,s))||t.enumerable});return r};var H=r=>M(x({},"__esModule",{value:!0}),r);var j={};A(j,{default:()=>b});module.exports=H(j);var u=require("obsidian");var C=class{constructor({baseUrlGetter:i=()=>"",tokenGetter:e=()=>"",sessionIDGetter:t=()=>""}){this._baseUrlGetter=i,this._tokenGetter=e,this._sessionIDGetter=t}get baseUrl(){return this._baseUrlGetter()}get token(){return this._tokenGetter()}get sessionID(){return this._sessionIDGetter()}async get(i,e={}){let t=new URL(`${this._baseUrlGetter()}${i}`);return Object.keys(e).forEach(s=>t.searchParams.append(s,e[s])),await this._fetch(t.toString(),{method:"GET"})}async post(i,e={}){let t=new FormData;for(let s in e){let n=e[s];n instanceof Array&&(n=JSON.stringify(n)),t.append(s,n)}return await this._fetch(`${this._baseUrlGetter()}${i}`,{method:"POST",body:t})}async put(i,e){let t=new FormData;return t.append("key",this._tokenGetter()),t.append("session_id",this._sessionIDGetter()),t.append("file",e),await this._fetch(`${this._baseUrlGetter()}${i}`,{method:"PUT",body:t})}async delete(i,e={}){let t=new FormData;for(let s in e){let n=e[s];n instanceof Array&&(n=JSON.stringify(n)),t.append(s,n)}return t.append("key",this._tokenGetter()),t.append("session_id",this._sessionIDGetter()),await this._fetch(`${this._baseUrlGetter()}${i}`,{method:"DELETE",body:t})}async _fetch(i,e){if(e===void 0&&(e={}),e.headers===void 0?e.headers=new Headers:typeof e.headers=="string"?e.headers=new Headers(e.headers):e.headers=new Headers(e.headers),e.headers.append("Authorization",`Bearer ${this._tokenGetter()}`),(e==null?void 0:e.method)==="GET"){let s=new URL(i);s.searchParams.append("session_id",this._sessionIDGetter()),i=s.toString()}else if((e==null?void 0:e.method)==="POST"||(e==null?void 0:e.method)==="PUT"||(e==null?void 0:e.method)==="DELETE")if(typeof e.body=="string")e.body=JSON.stringify({session_id:this._sessionIDGetter(),...JSON.parse(e.body)});else if(e.body instanceof FormData)e.body.has("session_id")||e.body.append("session_id",this._sessionIDGetter());else throw new Error("Not implemented body type");let t=await fetch(i,e);if(!t.ok)throw new Error(`Request failed with status ${t.status}`);return t}},G=C;var q={doc_type:"",has_file:!1,file_type:"",year:"0000",title:" ",author:" ",authors:[" "],publication:null,tags:[],uuid:" ",url:"about:blank",time_added:0,time_modified:0,bibtex:"",doc_size:0,note_linecount:0,has_abstract:!1},g=class{constructor(){this.parseMarkdown=(i,e,t,s)=>(e=e.replace(new RegExp("./misc/","g"),`${i}/misc/${t.uuid}?u=${s.id}&&fname=`),e)}init(i,e){let t=Math.random().toString(36).substring(2,15);return this._fetcher=new G({baseUrlGetter:i,tokenGetter:e,sessionIDGetter:()=>"obsidian-"+t}),this}async reqUserInfo(){return await this._fetcher.post("/api/auth").then(i=>i.json())}async reqDatapointSummary(i){try{return await this._fetcher.get(`/api/datainfo/${i}`).then(e=>e.json())}catch(e){return console.log(e),q}}async reqDatapointAbstract(i){return await this._fetcher.get(`/api/datainfo-supp/abstract/${i}`).then(e=>e.text())}async reqDatapointNote(i){return await this._fetcher.get(`/api/datainfo-supp/note/${i}`).then(e=>e.text())}};var O={endpoint:"",credential:""},_=new Map;async function L(r,i){let e=r.map(async t=>{if(!_.has(t)){let s=await i.reqDatapointSummary(t);s&&_.set(t,s)}return _.get(t)});return await Promise.all(e)}var b=class extends u.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new P(this.app,this)),this.api=new g().init(()=>this.settings.endpoint,()=>this.settings.credential),console.log("loading Lires plugin, time: ",Date.now()),this.api.reqUserInfo().then(e=>{this.userInfo=e}),this.registerMarkdownCodeBlockProcessor("lires-cite",(e,t,s)=>{let n=e.split(`
`).filter(a=>a.length>0);L(n,this.api).then(a=>{for(let h of a)h&&t.appendChild(F(this,h));let l=document.createElement("div");l.style.width="100%",l.style.display="flex",l.style.paddingRight="1em",l.style.justifyContent="flex-end",l.appendChild(y({text:"details",clickHandler:h=>{new k(this,n).open()}})),t.appendChild(l)})}),this.registerMarkdownCodeBlockProcessor("lires-ref",(e,t,s)=>{let n=e.split(`
`).filter(a=>a.length>0);L(n,this.api).then(a=>{for(let l of a)l&&t.appendChild(v(this,l))})})}onunload(){}async loadSettings(){this.settings=Object.assign({},O,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}},I=class extends u.Modal{constructor(e,t){super(e);this.data=t}onOpen(){let{contentEl:e}=this,t=document.createElement("textarea");t.value=this.data.bibtex,t.style.width="100%",t.style.height="100%",t.style.minHeight="300px",t.style.resize="none",t.readOnly=!0,e.appendChild(t)}onClose(){let{contentEl:e}=this;e.empty()}},k=class extends u.Modal{constructor(e,t){super(e.app);this.uids=t,this.plugin=e}onOpen(){let{contentEl:e}=this;L(this.uids,this.plugin.api).then(t=>{for(let s of t)s&&e.appendChild(v(this.plugin,s))})}onClose(){let{contentEl:e}=this;e.empty()}},P=class extends u.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new u.Setting(e).setName("Endpoint").setDesc("The url of the Lires endpoint.").addText(t=>t.setPlaceholder("https://example.com:8080").setValue(this.plugin.settings.endpoint).onChange(async s=>{this.plugin.settings.endpoint=s,await this.plugin.saveSettings()})),new u.Setting(e).setName("Credential").setDesc("It's a secret").addText(t=>t.setPlaceholder("Enter your secret").setValue(this.plugin.settings.credential).onChange(async s=>{this.plugin.settings.credential=s,await this.plugin.saveSettings()}))}};function y({url:r="",text:i="",clickHandler:e=null,startBracket:t="[",endBracket:s="] "}={}){let n=document.createElement("span");n.classList.add("lires-cite-link");let a=document.createElement("a");return a.classList.add("lires-cite-link"),a.innerText=i,r&&(a.href=r),e&&(a.onclick=e),n.appendChild(document.createTextNode(t)),n.appendChild(a),n.appendChild(document.createTextNode(s)),n}function F(r,i){if(!i.uuid.trim()){let l=document.createElement("div");return l.innerText="Failed to load data",l}let e=document.createElement("div");e.classList.add("lires-cite-line");let t=document.createElement("span");t.classList.add("lires-cite-uuid"),t.innerText=i.uuid;let s=document.createElement("span");s.innerText="\u2022",s.style.marginRight="0.5em",e.appendChild(s);let n=document.createElement("span");n.classList.add("lires-cite"),n.innerText=i.author+` (${i.year}) ${i.title}`,n.style.marginTop="0em";let a=document.createElement("div");return a.style.display="flex",a.style.flexDirection="row",a.appendChild(s),a.appendChild(n),e.appendChild(t),e.appendChild(a),e}function v(r,i){let e=document.createElement("div");if(!i.uuid.trim()){let n=document.createElement("div");return n.innerText="Failed to load data",n.style.color="red",n.style.fontWeight="bold",n.style.margin="1em",e.appendChild(n),e}let t=n=>{let a=document.createElement("div");a.classList.add("lires-ref");let l=document.createElement("div");l.classList.add("lires-ref-uuid"),l.innerText="lires:"+n.uuid,a.appendChild(l);let h=document.createElement("h3");h.classList.add("lires-ref-title"),h.innerText=n.title,a.appendChild(h);let d=document.createElement("div");if(d.classList.add("lires-ref-info"),d.style.marginLeft="1em",d.style.marginTop="0.5em",n.publication){let o=document.createElement("span");o.classList.add("lires-ref-publication"),o.innerText=`(${n.year}) `+n.publication,d.appendChild(o),d.appendChild(document.createElement("br"))}let w=document.createElement("span");w.classList.add("lires-ref-authors");for(let o of n.authors){let p=document.createElement("span");p.classList.add("lires-ref-author"),p.innerText=o,o!==n.authors[n.authors.length-1]&&(p.innerText+="; "),w.appendChild(p)}d.appendChild(w),d.appendChild(document.createElement("br")),d.appendChild(y({url:r.settings.endpoint+"#reader/"+n.uuid,text:"reader"})),n.has_file&&d.appendChild(y({url:r.settings.endpoint+"/doc/"+n.uuid+"?u="+r.userInfo.id,text:"doc"})),n.url&&d.appendChild(y({url:n.url,text:"url"})),d.appendChild(y({text:"bibtex",clickHandler:o=>{new I(r.app,n).open()}}));let E=document.createElement("a");E.classList.add("lires-ref-reload"),E.innerText="reload",E.onclick=()=>{s()},d.appendChild(E),a.appendChild(d);function S(){let o=document.createElement("details");o.classList.add("lires-ref-detail");let p=document.createElement("summary");p.innerText="Abstract",o.appendChild(p);let c=document.createElement("p");c.classList.add("lires-ref-detail");function D(m){!m.target||!(m.target instanceof HTMLDetailsElement)||m.target.open&&(c.innerHTML="Loading...",r.api.reqDatapointAbstract(n.uuid).then(f=>{f!==""?c.innerText=f:c.innerText="Not available"}))}return o.addEventListener("toggle",D),o.appendChild(c),o}function U(){let o=document.createElement("details");o.classList.add("lires-ref-detail");let p=document.createElement("summary");p.innerText="Note",o.appendChild(p);let c=document.createElement("div");c.classList.add("lires-ref-detail");function D(m){!m.target||!(m.target instanceof HTMLDetailsElement)||m.target.open&&(c.innerHTML="Loading...",c.style.maxWidth="100%",r.api.reqDatapointNote(n.uuid).then(f=>{f!==""?(c.innerHTML="",f=r.api.parseMarkdown(r.settings.endpoint,f,n,r.userInfo),u.MarkdownRenderer.render(r.app,f,c,"__none_exist__",r)):c.innerText="Not available"}))}return o.addEventListener("toggle",D),o.appendChild(c),o}let T=document.createElement("div");return n.has_abstract&&T.appendChild(S()),n.note_linecount&&T.appendChild(U()),a.appendChild(T),a},s=()=>{let n=i.uuid;r.api.reqDatapointSummary(n).then(a=>{a&&(e.innerHTML="",_.set(n,a),e.appendChild(t(a)))})};return e.appendChild(t(i)),e}
