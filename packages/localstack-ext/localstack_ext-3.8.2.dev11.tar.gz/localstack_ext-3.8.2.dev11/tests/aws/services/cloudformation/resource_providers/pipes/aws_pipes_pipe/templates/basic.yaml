AWSTemplateFormatVersion: '2010-09-09'
Description: Template to exercise create and delete operations for AWS::Pipes::Pipe
Resources:
  SourceQueue:
    Type: AWS::SQS::Queue

  TargetQueue:
    Type: AWS::SQS::Queue

  PipeRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - pipes.amazonaws.com
            Action:
              - sts:AssumeRole
            # TODO: a condition on the account would be safer here
      Policies:
        - PolicyName: SourcePolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - "sqs:ReceiveMessage"
                  - "sqs:DeleteMessage"
                  - "sqs:GetQueueAttributes"
                Resource: !GetAtt SourceQueue.Arn
        - PolicyName: TargetPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - "sqs:SendMessage"
                Resource: !GetAtt TargetQueue.Arn

  MyResource:
    Type: AWS::Pipes::Pipe
    Properties:
      RoleArn: !GetAtt PipeRole.Arn
      Source: !GetAtt SourceQueue.Arn
      Target: !GetAtt TargetQueue.Arn


Outputs:
  MyRef:
    Value:
      Ref: MyResource
  RoleName:
    Value:
      Ref: PipeRole
  SourceQueueName:
    Value: !GetAtt SourceQueue.QueueName
  TargetQueueName:
    Value: !GetAtt TargetQueue.QueueName
