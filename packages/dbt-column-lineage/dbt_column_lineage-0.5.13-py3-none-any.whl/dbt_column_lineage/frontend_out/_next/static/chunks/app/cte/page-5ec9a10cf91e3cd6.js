(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[318],{79826:function(e,t,s){Promise.resolve().then(s.bind(s,86741))},86741:function(e,t,s){"use strict";s.d(t,{Cte:function(){return L}});var a=s(57437),n=s(16463),l=s(27289),r=s(2265),o=s(6785),i=s(63775),c=s(50197);s(10715);var d=s(37215),u=s(71165),h=s(20707),m=s(20548),f=s(37642),x=s(29820),p=s.n(x),b=s(92168),g=s(19997);let j=h.tk.theme({".cm-content":{fontFamily:"Roboto !important",fontSize:"smaller"}}),k=h.Py.define(),y=h.QQ.define({create:()=>h.p.none,update(e,t){for(let s of(e=e.map(t.changes),t.effects))s.is(k)&&(e=e.update({add:s.value,sort:!0}));return e},provide:e=>h.tk.decorations.from(e)}),N=(e,t,s)=>{let a=new(p()).graphlib.Graph().setDefaultEdgeLabel(()=>({}));return a.setGraph({rankdir:s}),t.forEach(e=>a.setEdge(e.source,e.target)),e.forEach(e=>a.setNode(e.id,{label:e.id,width:150,height:40})),p().layout(a),e.forEach(e=>{let t=a.node(e.id);switch(s){case"TB":e.targetPosition=o.Ly.Top,e.sourcePosition=o.Ly.Bottom;break;case"BT":e.targetPosition=o.Ly.Bottom,e.sourcePosition=o.Ly.Top;break;case"LR":e.targetPosition=o.Ly.Left,e.sourcePosition=o.Ly.Right;break;case"RL":e.targetPosition=o.Ly.Right,e.sourcePosition=o.Ly.Left}return e.position={x:t.x-75,y:t.y-20},e}),{nodes:e,edges:t}},v=e=>{let{columns:t}=e;return(0,a.jsxs)("table",{className:"table-auto text-xs w-full",children:[(0,a.jsx)("thead",{className:"sticky top-0 z-10",children:(0,a.jsxs)("tr",{className:"bg-gray-200",children:[(0,a.jsx)("th",{className:"border",children:"Column"}),(0,a.jsx)("th",{className:"border",children:"Type"}),(0,a.jsx)("th",{className:"border",children:"Description"})]})}),(0,a.jsx)("tbody",{children:Object.keys(t).map((e,s)=>(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{className:"border",children:t[e].name.toLowerCase()}),(0,a.jsx)("td",{className:"border",children:t[e].type}),(0,a.jsx)("td",{className:"border",children:t[e].comment})]},s))})]})};function w(e,t){let s=new m.FH(e.state.doc,t),a=[];for(let e=s.next();!e.done;e=s.next())a.push({from:e.value.from,to:e.value.to});return a}let C=e=>{let{nodes:t,edges:s,setNodes:l,setEdges:d,nodesPositioned:m,setNodesPositioned:f,codeMirrorRef:x,lineageTableColumns:p}=e,b=(0,r.useRef)(!0),{fitView:g}=(0,o._K)();(0,n.useRouter)();let j=(0,n.useSearchParams)(),[y,v]=(0,r.useState)(!1),[C,L]=(0,r.useState)(!1),S=(0,u.o)(e=>e.options),P=(0,u.o)(e=>e.setOptions),R=(0,r.useCallback)(async e=>{P({rankdir:e}),f(!1)},[j]),T=(0,r.useCallback)((e,t,s)=>{console.log(t,s);let a=new URLSearchParams({schema:e,sources:t,activeSource:t});if(s){let e=JSON.stringify({[t]:[s]});a.set("selectedColumns",e)}window.open("/cte?".concat(a.toString()),"_blank")},[j]),_=(0,r.useCallback)(e=>{if(null==x.current||null==x.current.view)return;if(null!=e.data.db){T(e.data.db,e.data.table,e.data.column);return}let t=x.current.view,s=w(t,"".concat(e.data.label," as ("));s&&(null==t||t.dispatch({selection:{head:s[0].from,anchor:s[0].to},scrollIntoView:!0,effects:h.tk.scrollIntoView(s[0].from,{x:"start",y:"start"})}))},[j]),E=(0,r.useCallback)(e=>t=>(("input"===t.type||t.has_db)&&(t.hidden=e),t),[]),B=(0,r.useCallback)(e=>{L(e),f(!1)},[]),F=(0,r.useCallback)(()=>{if(0==t.length||m)return;let e=N(t,s,S.rankdir);l([...e.nodes].map(E(C))),d([...e.edges].map(E(C))),window.requestAnimationFrame(()=>{setTimeout(()=>g(),0)}),v(!0),f(!0)},[m]),O=(0,r.useCallback)(e=>l(t=>(0,o.Fb)(e,t)),[l]),D=(0,r.useCallback)(e=>d(t=>(0,o.yn)(e,t)),[d]),Z=(0,r.useCallback)(e=>d(t=>(0,o.Z_)(e,t)),[d]);return(0,r.useEffect)(()=>{if(0==t.length||m||null==x.current||null==x.current.view)return;let e=[],s=h.p.mark({class:"bg-yellow-200"}),a=j.get("sources"),n=j.get("selectedColumns");if(a&&n){let t=JSON.parse(n)[a][0]||"";for(let a of w(x.current.view,t))e.push(s.range(a.from,a.to))}x.current.view.dispatch({effects:k.of(e)})},[m,x.current]),(0,r.useEffect)(()=>{b.current||F()},[m]),(0,r.useEffect)(()=>{P({rankdir:"TB"}),b.current=!1},[]),(0,a.jsx)(r.Suspense,{children:(0,a.jsxs)(o.x$,{nodes:t,edges:s,onNodesChange:O,onEdgesChange:D,onConnect:Z,onNodeClick:(e,t)=>_(t),children:[(0,a.jsxs)(o.s_,{position:"top-right",children:[(0,a.jsx)("div",{children:(0,a.jsxs)("select",{value:S.rankdir,onChange:e=>R(e.target.value),children:[(0,a.jsx)("option",{value:"LR",children:"Left - Right"}),(0,a.jsx)("option",{value:"RL",children:"Right - Left"}),(0,a.jsx)("option",{value:"TB",children:"Top - Bottom"}),(0,a.jsx)("option",{value:"BT",children:"Bottom - Top"})]})}),(0,a.jsx)("div",{children:(0,a.jsxs)("label",{htmlFor:"ishidden",children:[(0,a.jsx)("input",{id:"ishidden",type:"checkbox",checked:C,onChange:e=>B(e.target.checked)}),"Hide source table"]})})]}),(0,a.jsx)(i.Z,{}),(0,a.jsx)(c.A,{style:{backgroundColor:"#f5f5f5"}})]})})},L=()=>{let{height:e,width:t}=(0,l.Y)(),[s,i]=(0,o.Rr)([]),[c,u]=(0,o.ll)([]),[m,x]=(0,r.useState)(!0),p=(0,r.useRef)(null),[k,N]=(0,r.useState)("lineage"),[w,L]=(0,r.useState)(""),[S,P]=(0,r.useState)(""),[R,T]=(0,r.useState)(""),[_,E]=(0,r.useState)(""),[B,F]=(0,r.useState)([]),[O,D]=(0,r.useState)({}),Z=(0,n.useRouter)(),z=(0,r.useCallback)(async e=>{let{sources:t,columns:s}=e;i([]),u([]);let a=t[0],n=s[a]?s[a][0]:"",l=new URLSearchParams({source:a,column:n}),r=await fetch("".concat("","/api/v1/cte?").concat(l)),o=await r.json();return 200!=r.status?(alert(o.error),Z.back(),!1):(i(o.nodes),u(o.edges),L(o.table_name),P(o.materialized),T(o.query),E(o.description),F(o.columns),D(o.lineage_table_columns),setTimeout(()=>x(!1),100),U(),!0)},[Z]),U=(0,r.useCallback)(()=>{N("lineage"),setTimeout(()=>x(!1),100)},[N,x]);return(0,a.jsxs)("div",{children:[(0,a.jsx)(d.h,{handleFetchData:z}),(0,a.jsxs)("div",{className:"flex flex-wrap",children:[(0,a.jsxs)("div",{className:"w-1/2",children:[(0,a.jsxs)("h4",{className:"px-1 text-2xl font-bold flex items-center",children:[(0,a.jsx)("span",{className:"select-text",children:w}),(0,a.jsx)("small",{className:"ms-2 font-semibold text-gray-500 dark:text-gray-400 select-text",children:S})]}),(0,a.jsx)("div",{className:"px-2",style:{height:.85*e,overflowY:"auto"},children:(0,a.jsx)(h.ZP,{ref:p,value:R,theme:j,extensions:[(0,f.i6)(),y]})})]}),(0,a.jsxs)("div",{className:"w-1/2",style:{height:e-55-24},children:[(0,a.jsxs)("div",{className:"mx-2",children:[(0,a.jsx)("button",{className:"px-1 "+("description"==k&&"font-semibold"),onClick:()=>N("description"),children:"Description"}),(0,a.jsx)("button",{className:"px-1 "+("columns"==k&&"font-semibold"),onClick:()=>N("columns"),children:"Columns"}),(0,a.jsx)("button",{className:"px-1 "+("lineage"==k&&"font-semibold"),onClick:()=>U(),children:"Lineage"})]}),"description"==k&&(0,a.jsx)(b.U,{className:"markdown",remarkPlugins:[g.Z],children:_}),"columns"==k&&(0,a.jsx)(v,{columns:B}),"lineage"==k&&(0,a.jsx)(o.tV,{children:(0,a.jsx)(C,{nodes:s,edges:c,setNodes:i,setEdges:u,codeMirrorRef:p,nodesPositioned:m,setNodesPositioned:x,lineageTableColumns:O})})]})]})]})}}},function(e){e.O(0,[489,780,401,346,704,49,971,23,744],function(){return e(e.s=79826)}),_N_E=e.O()}]);