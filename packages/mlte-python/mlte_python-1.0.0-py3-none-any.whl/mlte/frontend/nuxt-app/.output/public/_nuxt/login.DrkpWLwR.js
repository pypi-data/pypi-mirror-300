import{n as C,u as r,r as p,q as x,A as V,w as n,B as U,o as B,d as i,a as _,b as f,y as c,C as E,E as T,G as A,z as q}from"./entry.DCQbuYPM.js";import{r as I}from"./util.kUQp-Jt0.js";import{i as N}from"./form-methods.D-YS39W_.js";import{r as g,h}from"./http-error-handling.BbcmLHJS.js";const P={style:{"max-width":"30rem"}},L={class:"margin-button centered-container"},H=C({__name:"login",setup($){const v=q();r("token"),r("user"),r("userRole");const s=p(""),d=p(""),u=p({username:!1,password:!1});async function k(){u.value=I(u.value);let m=!1;if(s.value.trim()===""&&(u.value.username=!0,m=!0),d.value.trim()===""&&(u.value.password=!0,m=!0),m){N();return}const o={grant_type:"password",username:s.value,password:d.value};let a=[];for(const l in o){const e=encodeURIComponent(l),t=encodeURIComponent(o[l]);a.push(e+"="+t)}a=a.join("&");try{await $fetch(v.public.apiPath+"/token",{retry:0,method:"POST",headers:{accept:"application/json","Content-Type":"application/x-www-form-urlencoded"},body:a,onRequestError(){g()},onResponse({response:e}){var t,w,y;if(e.ok){const R=r("token",{secure:!0,maxAge:(t=e==null?void 0:e._data)==null?void 0:t.expires_in}),b=r("user",{maxAge:(w=e==null?void 0:e._data)==null?void 0:w.expires_in});R.value=(y=e==null?void 0:e._data)==null?void 0:y.access_token,b.value=s.value}},onResponseError({response:e}){h(e.status,e._data.error_description)}});const l=r("token");await $fetch(v.public.apiPath+"/user/me",{retry:0,method:"GET",headers:{Authorization:"Bearer "+l.value},onRequestError(){g()},onResponse({response:e}){if(e.ok){const t=r("userRole");t.value=e._data.role}},onResponseError({response:e}){h(e.status,e._data.error_description)}}),A("/")}catch{}}return(m,o)=>{const a=x("UsaTextInput"),l=x("UsaButton"),e=U;return B(),V(e,{name:"base-layout"},{"page-title":n(()=>[i("Login")]),default:n(()=>[_("form",null,[_("div",P,[f(a,{modelValue:c(s),"onUpdate:modelValue":o[0]||(o[0]=t=>E(s)?s.value=t:null),error:c(u).username},{label:n(()=>[i(" Username ")]),"error-message":n(()=>[i(" Enter a username ")]),_:1},8,["modelValue","error"]),f(a,{modelValue:c(d),"onUpdate:modelValue":o[1]||(o[1]=t=>E(d)?d.value=t:null),error:c(u).password,type:"password"},{label:n(()=>[i(" Password ")]),"error-message":n(()=>[i(" Enter a password ")]),_:1},8,["modelValue","error"]),_("div",L,[f(l,{type:"submit",class:"primary-button",onClick:o[2]||(o[2]=T(t=>k(),["prevent"]))},{default:n(()=>[i(" Login ")]),_:1})])])])]),_:1})}}});export{H as default};
