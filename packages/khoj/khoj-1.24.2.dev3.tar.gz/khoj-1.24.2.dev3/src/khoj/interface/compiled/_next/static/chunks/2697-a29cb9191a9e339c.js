(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2697],{82697:function(e,t,n){"use strict";n.d(t,{Z:function(){return x}});var s=n(57437),a=n(15238),o=n.n(a),r=n(2265),i=n(89178),l=n(94880),c=n(58485),g=n(16288),u=n(20721),h=n(26100),d=n(19666),m=n(50495),f=e=>{let{name:t,avatar:n,link:a,description:o}=e;return(0,s.jsx)("div",{className:"relative group flex",children:(0,s.jsx)(d.pn,{children:(0,s.jsxs)(d.u,{children:[(0,s.jsx)(d.aJ,{asChild:!0,children:(0,s.jsxs)(m.z,{variant:"ghost",className:"flex items-center justify-center",children:[n,(0,s.jsx)("div",{children:t})]})}),(0,s.jsx)(d._v,{children:(0,s.jsxs)("div",{className:"w-80 h-30",children:[(0,s.jsx)("a",{href:a,target:"_blank",rel:"noreferrer",className:"mt-1 ml-2 block no-underline",children:(0,s.jsxs)("div",{className:"flex items-center justify-start gap-2",children:[n,(0,s.jsxs)("div",{className:"mr-2 mt-1 flex justify-center items-center text-sm font-semibold text-gray-800",children:[t,(0,s.jsx)(h.o,{weight:"bold",className:"ml-1"})]})]})}),o&&(0,s.jsx)("p",{className:"mt-2 ml-6 text-sm text-gray-600 line-clamp-2",children:o||"A Khoj agent"})]})})]})})})},v=n(89417),p=n(69591);function x(e){let[t,n]=(0,r.useState)(null),[a,h]=(0,r.useState)(0),[d,m]=(0,r.useState)(!0),x=(0,r.useRef)(null),b=(0,r.useRef)(null),j=(0,r.useRef)(null),y=(0,r.useRef)(null),[M,_]=(0,r.useState)(null),[C,w]=(0,r.useState)(!1),[N,I]=(0,r.useState)(!0),S=(0,p.IC)(),k="[data-radix-scroll-area-viewport]";(0,r.useEffect)(()=>{var e;let t=null===(e=b.current)||void 0===e?void 0:e.querySelector(k);if(!t)return;let n=()=>{let{scrollTop:e,scrollHeight:n,clientHeight:s}=t;I(n-(e+s)<=50)};return t.addEventListener("scroll",n),()=>t.removeEventListener("scroll",n)},[]),(0,r.useEffect)(()=>{e.incomingMessages&&e.incomingMessages.length>0&&N&&L()},[e.incomingMessages,N]),(0,r.useEffect)(()=>{t&&t.chat&&t.chat.length>0&&a<2&&requestAnimationFrame(()=>{var e;null===(e=j.current)||void 0===e||e.scrollIntoView({behavior:"auto",block:"start"})})},[t,a]),(0,r.useEffect)(()=>{if(!d||C)return;let s=new IntersectionObserver(s=>{s[0].isIntersecting&&d&&(w(!0),function(s){if(!d||C)return;let a=(s+1)*10,o="";if(e.conversationId)o="/api/chat/history?client=web&conversation_id=".concat(encodeURIComponent(e.conversationId),"&n=").concat(a);else{if(!e.publicConversationSlug)return;o="/api/chat/share/history?client=web&public_conversation_slug=".concat(e.publicConversationSlug,"&n=").concat(a)}fetch(o).then(e=>e.json()).then(a=>{if(e.setTitle(a.response.slug),a&&a.response&&a.response.chat&&a.response.chat.length>0){if(h(Math.ceil(a.response.chat.length/10)),a.response.chat.length===(null==t?void 0:t.chat.length)){m(!1),w(!1);return}e.setAgent(a.response.agent),n(a.response),w(!1),0===s?L(!0):H()}else{if(a.response.agent&&a.response.conversation_id){let t={chat:[],agent:a.response.agent,conversation_id:a.response.conversation_id,slug:a.response.slug};e.setAgent(a.response.agent),n(t)}m(!1),w(!1)}}).catch(e=>{console.error(e),window.location.href="/"})}(a))},{threshold:1});return x.current&&s.observe(x.current),()=>s.disconnect()},[d,a,C]),(0,r.useEffect)(()=>{m(!0),w(!1),h(0),n(null)},[e.conversationId]),(0,r.useEffect)(()=>{if(e.incomingMessages){let t=e.incomingMessages[e.incomingMessages.length-1];t&&!t.completed&&(_(e.incomingMessages.length-1),e.setTitle(t.rawQuery))}},[e.incomingMessages]);let H=()=>{var e;let t=null===(e=b.current)||void 0===e?void 0:e.querySelector(k);requestAnimationFrame(()=>{var e;null===(e=y.current)||void 0===e||e.scrollIntoView({behavior:"auto",block:"start"}),null==t||t.scrollBy({behavior:"smooth",top:-150})})},L=function(){var e;let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=null===(e=b.current)||void 0===e?void 0:e.querySelector(k);requestAnimationFrame(()=>{null==n||n.scrollTo({top:n.scrollHeight,behavior:t?"auto":"smooth"})}),I(!0)};return e.conversationId||e.publicConversationSlug?(0,s.jsx)(l.x,{className:"h-[80vh] relative",ref:b,children:(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:o().chatHistory,children:[(0,s.jsx)("div",{ref:x,style:{height:"1px"},children:C&&(0,s.jsx)(c.l,{message:"Loading Conversation",className:"opacity-50"})}),t&&t.chat&&t.chat.map((e,n)=>(0,s.jsx)(i.Z,{ref:n===t.chat.length-2?j:n===t.chat.length-(a-1)*10?y:null,isMobileWidth:S,chatMessage:e,customClassName:"fullHistory",borderLeftColor:"".concat(null==t?void 0:t.agent.color,"-500"),isLastMessage:n===t.chat.length-1},"".concat(n,"fullHistory"))),e.incomingMessages&&e.incomingMessages.map((e,n)=>(0,s.jsxs)(r.Fragment,{children:[(0,s.jsx)(i.Z,{isMobileWidth:S,chatMessage:{message:e.rawQuery,context:[],onlineContext:{},created:e.timestamp,by:"you",automationId:"",uploadedImageData:e.uploadedImageData},customClassName:"fullHistory",borderLeftColor:"".concat(null==t?void 0:t.agent.color,"-500")},"".concat(n,"outgoing")),e.trainOfThought&&function(e,t,n,a){let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],l=e.length-1;return(0,s.jsxs)("div",{className:"".concat(o().trainOfThought," shadow-sm"),children:[!r&&(0,s.jsx)(c.l,{className:"float-right"}),e.map((e,a)=>(0,s.jsx)(i.H,{message:e,primary:a===l&&t&&!r,agentColor:n},"train-".concat(a)))]},a)}(e.trainOfThought,n===M,(null==t?void 0:t.agent.color)||"orange","".concat(n,"trainOfThought"),e.completed),(0,s.jsx)(i.Z,{isMobileWidth:S,chatMessage:{message:e.rawResponse,context:e.context,onlineContext:e.onlineContext,created:e.timestamp,by:"khoj",automationId:"",rawQuery:e.rawQuery},customClassName:"fullHistory",borderLeftColor:"".concat(null==t?void 0:t.agent.color,"-500"),isLastMessage:!0},"".concat(n,"incoming"))]},"incomingMessage".concat(n))),e.pendingMessage&&(0,s.jsx)(i.Z,{isMobileWidth:S,chatMessage:{message:e.pendingMessage,context:[],onlineContext:{},created:new Date().getTime().toString(),by:"you",automationId:"",uploadedImageData:e.pendingMessage},customClassName:"fullHistory",borderLeftColor:"".concat(null==t?void 0:t.agent.color,"-500"),isLastMessage:!0},"pendingMessage-".concat(e.pendingMessage.length)),t&&(0,s.jsx)("div",{className:"".concat(o().agentIndicator," pb-4"),children:(0,s.jsx)("div",{className:"relative group mx-2 cursor-pointer",children:(0,s.jsx)(f,{name:t&&t.agent&&t.agent.name?t.agent.name:"Agent",link:t&&t.agent&&t.agent.slug?"/agents?agent=".concat(t.agent.slug):"/agents",avatar:(0,v.T)(t.agent.icon,t.agent.color)||(0,s.jsx)(g.v,{}),description:t&&t.agent&&t.agent.persona?t.agent.persona:""})})})]}),!N&&(0,s.jsx)("button",{title:"Scroll to bottom",className:"absolute bottom-4 right-5 bg-white dark:bg-[hsl(var(--background))] text-neutral-500 dark:text-white p-2 rounded-full shadow-xl",onClick:()=>{L(),I(!0)},children:(0,s.jsx)(u.K,{size:24})})]})}):null}},15238:function(e){e.exports={chatHistory:"chatHistory_chatHistory__CoaVT",chatLayout:"chatHistory_chatLayout__ABli_",agentIndicator:"chatHistory_agentIndicator__wOU1f",trainOfThought:"chatHistory_trainOfThought__mMWSR"}}}]);