stages:
  - test
  - publish

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

Check code quality:
  stage: test
  image: python:${PYTHON_VERSION}-slim-bullseye
  cache:
    paths:
      - .cache/pip
  before_script:
    - apt update && apt install -y git
    - pip install -r requirements-dev.txt
    - pip install -e .
  script:
    - pre-commit run --all-files
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.10", "3.11", "3.12"]

Trigger doc build on readthedocs.org:
  stage: publish
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  image: alpine:3
  before_script:
    - apk add curl jq
  script:
    - |
      OUT=$(curl --silent --fail -X POST -d "branches=$CI_COMMIT_REF_NAME" -d "token=$READTHEDOCS_TOKEN" https://readthedocs.org/api/v2/webhook/dbnomics-fetcher-toolbox/107732/)
      echo $OUT
      echo $OUT | jq --exit-status ".build_triggered == true"

Publish on PyPI:
  stage: publish
  image: python:3.11-slim-bullseye
  rules:
    - if: $CI_COMMIT_TAG
  cache:
    paths:
      - .cache/pip
  before_script:
    - pip install -U build twine
  script:
    - python -m build
    # TWINE_USERNAME and TWINE_PASSWORD env variables are defined in https://git.nomics.world/groups/dbnomics/-/settings/ci_cd
    - twine upload dist/*
  environment:
    name: PyPI
    url: https://pypi.org/project/dbnomics-fetcher-toolbox/$CI_COMMIT_TAG
